import React, { useState, useEffect, useRef, useCallback } from 'react';

// --- Audio Engine (Web Audio API) ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

// Music State
let musicInterval = null;
let noteIndex = 0;
const musicNotes = [
  261.63, 329.63, 392.00, 493.88, // C4, E4, G4, B4
  523.25, 493.88, 392.00, 329.63, // C5, B4, G4, E4
  293.66, 349.23, 440.00, 523.25, // D4, F4, A4, C5 (Dm7)
  587.33, 523.25, 440.00, 349.23  // D5, C5, A4, F4
];

const playMusicNote = () => {
  if (audioCtx.state === 'suspended') audioCtx.resume();
  
  const osc = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();
  
  osc.connect(gainNode);
  gainNode.connect(audioCtx.destination);

  const now = audioCtx.currentTime;
  const freq = musicNotes[noteIndex];
  noteIndex = (noteIndex + 1) % musicNotes.length;

  osc.type = 'triangle'; // Softer 8-bit sound
  osc.frequency.setValueAtTime(freq, now);
  
  // Envelope for relaxing feel
  gainNode.gain.setValueAtTime(0, now);
  gainNode.gain.linearRampToValueAtTime(0.03, now + 0.1); // Low volume
  gainNode.gain.exponentialRampToValueAtTime(0.001, now + 1.5);

  osc.start(now);
  osc.stop(now + 1.5);
};

const toggleMusic = (shouldPlay) => {
  if (shouldPlay) {
    if (!musicInterval) {
      // Play a note every 600ms
      musicInterval = setInterval(playMusicNote, 600);
    }
  } else {
    if (musicInterval) {
      clearInterval(musicInterval);
      musicInterval = null;
    }
  }
};

const playSound = (type) => {
  if (audioCtx.state === 'suspended') audioCtx.resume();
  const osc = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();
  
  osc.connect(gainNode);
  gainNode.connect(audioCtx.destination);

  const now = audioCtx.currentTime;

  switch (type) {
    case 'pop':
      osc.type = 'sine';
      osc.frequency.setValueAtTime(800, now);
      osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
      gainNode.gain.setValueAtTime(0.1, now);
      gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
      osc.start(now);
      osc.stop(now + 0.1);
      break;
    case 'blip': 
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(600, now);
      osc.frequency.linearRampToValueAtTime(800, now + 0.05);
      gainNode.gain.setValueAtTime(0.05, now);
      gainNode.gain.linearRampToValueAtTime(0, now + 0.05);
      osc.start(now);
      osc.stop(now + 0.05);
      break;
    case 'zap':
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(500, now);
      osc.frequency.linearRampToValueAtTime(100, now + 0.2);
      gainNode.gain.setValueAtTime(0.2, now);
      gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
      osc.start(now);
      osc.stop(now + 0.2);
      break;
    case 'rub':
      const bufferSize = audioCtx.sampleRate * 0.1;
      const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const data = buffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
      
      const noise = audioCtx.createBufferSource();
      noise.buffer = buffer;
      const noiseGain = audioCtx.createGain();
      noiseGain.gain.setValueAtTime(0.05, now);
      noiseGain.gain.linearRampToValueAtTime(0, now + 0.1);
      noise.connect(noiseGain);
      noiseGain.connect(audioCtx.destination);
      noise.start(now);
      break;
    case 'roll': 
      osc.type = 'square';
      osc.frequency.setValueAtTime(100, now);
      osc.frequency.exponentialRampToValueAtTime(50, now + 0.15);
      gainNode.gain.setValueAtTime(0.05, now);
      gainNode.gain.linearRampToValueAtTime(0, now + 0.15);
      osc.start(now);
      osc.stop(now + 0.15);
      break;
    case 'swish': 
      osc.type = 'sine';
      osc.frequency.setValueAtTime(200, now);
      osc.frequency.linearRampToValueAtTime(600, now + 0.2);
      gainNode.gain.setValueAtTime(0.02, now);
      gainNode.gain.linearRampToValueAtTime(0, now + 0.2);
      osc.start(now);
      osc.stop(now + 0.2);
      break;
    case 'success':
      osc.type = 'sine';
      osc.frequency.setValueAtTime(440, now);
      osc.frequency.setValueAtTime(554, now + 0.1); // C#
      osc.frequency.setValueAtTime(659, now + 0.2); // E
      gainNode.gain.setValueAtTime(0.1, now);
      gainNode.gain.linearRampToValueAtTime(0, now + 0.4);
      osc.start(now);
      osc.stop(now + 0.4);
      break;
    case 'fail':
      osc.type = 'square';
      osc.frequency.setValueAtTime(150, now);
      osc.frequency.linearRampToValueAtTime(100, now + 0.3);
      gainNode.gain.setValueAtTime(0.1, now);
      gainNode.gain.linearRampToValueAtTime(0, now + 0.3);
      osc.start(now);
      osc.stop(now + 0.3);
      break;
    default:
      break;
  }
};

// --- Global Styles ---
const GlobalStyles = () => (
  <style>
    {`
      @import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap');
      body { font-family: 'Comic Neue', 'Comic Sans MS', sans-serif; background-color: #f0f9ff; }
      .sim-container { touch-action: none; }
      
      @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-6px); }
        100% { transform: translateY(0px); }
      }
      .floating { animation: float 3s ease-in-out infinite; }
      
      .particle { transition: all 0.5s ease-out; }
      .animate-spin-slow { animation: spin 10s linear infinite; }
      @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
      
      /* Physics & Interaction Classes */
      .draggable { cursor: grab; touch-action: none; }
      .draggable:active { cursor: grabbing; }
      
      .no-lag { transition: none; }
      .smooth-catchup { transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); }

      .flying-electron {
        animation: flyToTarget 0.6s ease-out forwards;
      }
      @keyframes flyToTarget {
        0% { transform: translate(0, 0) scale(1); opacity: 1; }
        100% { transform: translate(var(--tx), var(--ty)) scale(0.5); opacity: 0; }
      }

      .speech-bubble::before {
        content: '';
        position: absolute;
        left: -12px;
        top: 24px;
        border-top: 10px solid transparent;
        border-bottom: 10px solid transparent;
        border-right: 12px solid #FCD34D; 
      }

      @keyframes pointMove {
        0% { transform: translateX(0); opacity: 0.5; }
        50% { transform: translateX(10px); opacity: 1; }
        100% { transform: translateX(0); opacity: 0.5; }
      }
      .arrow-anim { animation: pointMove 1.5s infinite; }
    `}
  </style>
);

// --- Shared Components ---

const Button = ({ onClick, children, disabled, className = "" }) => (
  <button 
    onClick={(e) => { playSound('pop'); onClick(e); }} 
    disabled={disabled}
    className={`px-6 py-2 rounded-full font-bold shadow-lg transform transition active:scale-95 ${disabled ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-400 text-white'} ${className}`}
  >
    {children}
  </button>
);

// --- Sparkle Character Component ---
const Sparkle = ({ message, emotion = 'happy', speak = true }) => {
  const [isSpeaking, setIsSpeaking] = useState(false);

  useEffect(() => {
    if (!speak) {
      window.speechSynthesis.cancel();
      return;
    }

    window.speechSynthesis.cancel();

    // Sanitize text
    const spokenText = message.replace(/\s?\(?[+-]\)?/g, '').replace(/\s?\(0\)/g, '');

    const utterance = new SpeechSynthesisUtterance(spokenText);
    utterance.lang = 'en-US';
    // Female voice adjustments
    utterance.pitch = 1.2; 
    utterance.rate = 1.0; 
    
    const voices = window.speechSynthesis.getVoices();
    const preferredVoice = voices.find(v => 
        v.name.includes('Google US English') || 
        v.name.includes('Zira') || 
        v.name.includes('Samantha') ||
        v.name.includes('Female')
    ) || voices[0];
    
    if (preferredVoice) utterance.voice = preferredVoice;

    utterance.onstart = () => setIsSpeaking(true);
    utterance.onend = () => setIsSpeaking(false);

    window.speechSynthesis.speak(utterance);

    return () => {
      window.speechSynthesis.cancel();
    };
  }, [message, speak]);

  return (
    <div className="flex items-start gap-4 mb-6 w-full max-w-4xl animate-fadeIn z-50 relative">
      <div className="flex-shrink-0 flex flex-col items-center">
        {/* Sparkle Container */}
        <div className="text-8xl relative floating">
          {/* Face - Static */}
          <span 
            role="img" 
            aria-label="Sparkle" 
            className="inline-block origin-bottom"
            style={{ filter: emotion === 'shocked' ? 'invert(1)' : 'none' }}
          >
            {emotion === 'shocked' ? 'üò≤' : 'üë©'}
          </span>

          {/* Antenna/Spark */}
          <div className="absolute -top-2 -right-4 text-5xl text-yellow-600 font-bold z-20 drop-shadow-md">‚ö°</div>
          
          {/* Speaking Indicator (Subtle pulse at bottom) */}
          {isSpeaking && (
            <div className="absolute bottom-0 left-1/2 -translate-x-1/2 w-full h-1 bg-yellow-400/50 blur-sm animate-pulse"></div>
          )}
        </div>
        <div className="font-bold text-purple-800 mt-2 bg-purple-200 px-3 py-0.5 rounded-full text-sm border border-purple-400 shadow-sm">Sparkle</div>
      </div>
      
      <div className="bg-white border-l-8 border-yellow-300 p-5 rounded-r-xl rounded-bl-xl shadow-md flex-grow relative speech-bubble mt-4 transition-all">
        <p className="text-gray-800 font-medium leading-relaxed text-lg">{message}</p>
      </div>
    </div>
  );
};

const GuideArrow = ({ text, className = "", direction = "right" }) => (
  <div className={`absolute pointer-events-none z-40 flex items-center ${className} ${direction === "left" ? "flex-row-reverse" : ""}`}>
    <span className="bg-white/90 px-2 py-1 rounded text-xs font-bold text-blue-600 shadow-sm whitespace-nowrap">{text}</span>
    <div className={`text-4xl text-blue-500 font-bold arrow-anim ${direction === "left" ? "rotate-180" : ""}`}>&rarr;</div>
  </div>
);

// --- STAGE 1: Atom Builder ---
const AtomBuilder = ({ onComplete, settings }) => {
  const [protons, setProtons] = useState(0);
  const [neutrons, setNeutrons] = useState(0);
  const [electrons, setElectrons] = useState(0);
  
  const isComplete = protons === 3 && neutrons === 4 && electrons === 3;
  
  const getMessage = () => {
      if (isComplete) return "Perfect! That's a stable Lithium atom. See how the Protons and Neutrons clump in the middle?";
      if (protons > 3) return "Whoa! Too many protons. The nucleus is unstable!";
      return "Let's build a Lithium atom! I need 3 Protons (+), 4 Neutrons (0), and 3 Electrons (-).";
  };

  const getPos = (index) => {
    const angle = index * 2.39996; 
    const r = 12 * Math.sqrt(index); 
    return { x: r * Math.cos(angle), y: r * Math.sin(angle) };
  };

  return (
    <div className="flex flex-col items-center w-full max-w-4xl mx-auto p-4 animate-fadeIn">
      <h2 className="text-2xl font-bold mb-4 text-purple-600">Step 1: Inside the Atom</h2>
      <Sparkle message={getMessage()} emotion={isComplete ? 'excited' : 'happy'} speak={settings.speak} />

      <div className="relative w-80 h-80 md:w-96 md:h-96 bg-gray-900 rounded-full flex items-center justify-center mb-6 overflow-hidden ring-4 ring-gray-200 shadow-xl">
        <div className="absolute w-64 h-64 border-2 border-dashed border-gray-600 rounded-full animate-spin-slow" style={{animationDuration: '10s'}}></div>
        <div className="absolute w-48 h-48 border-2 border-dashed border-gray-600 rounded-full animate-spin-slow" style={{animationDuration: '5s'}}></div>
        
        <div className="absolute w-24 h-24 flex items-center justify-center z-10 transition-all duration-300">
          {Array.from({ length: protons }).map((_, i) => {
            const pos = getPos(i);
            return (
              <div key={`p-${i}`} className="absolute w-5 h-5 bg-red-500 rounded-full shadow-sm border border-red-300 flex items-center justify-center text-[8px] text-white font-bold transition-all duration-500"
                   style={{ transform: `translate(${pos.x}px, ${pos.y}px)` }}>+</div>
            );
          })}
          {Array.from({ length: neutrons }).map((_, i) => {
            const pos = getPos(protons + i);
            return (
              <div key={`n-${i}`} className="absolute w-5 h-5 bg-gray-400 rounded-full shadow-sm border border-gray-300 transition-all duration-500"
                   style={{ transform: `translate(${pos.x}px, ${pos.y}px)` }}></div>
            );
          })}
        </div>

        {Array.from({ length: electrons }).map((_, i) => {
          const angle = (i / electrons) * 2 * Math.PI;
          const radius = 100 + (i % 2) * 30;
          const x = Math.cos(angle) * radius;
          const y = Math.sin(angle) * radius;
          return (
            <div key={`e-${i}`} className="absolute w-6 h-6 bg-yellow-400 rounded-full flex items-center justify-center font-bold text-xs shadow-glow transition-all duration-500"
                 style={{ transform: `translate(${x}px, ${y}px)` }}>
              -
            </div>
          );
        })}
      </div>

      <div className="grid grid-cols-3 gap-4 mb-4">
        {[{l:'Protons (+)', c:protons, s:setProtons, col:'red'}, {l:'Neutrons (0)', c:neutrons, s:setNeutrons, col:'gray'}, {l:'Electrons (-)', c:electrons, s:setElectrons, col:'yellow'}].map((item, idx) => (
           <div key={idx} className="flex flex-col items-center">
             <span className={`font-bold text-${item.col}-600 mb-1`}>{item.l}</span>
             <div className="flex gap-2 items-center">
               <Button onClick={() => { if(settings.sound) playSound('blip'); item.s(Math.max(0, item.c - 1)); }} className={`px-2 py-1 bg-${item.col}-200 text-black hover:bg-${item.col}-300`}>-</Button>
               <span className="text-xl font-mono w-6 text-center">{item.c}</span>
               <Button onClick={() => { if(settings.sound) playSound('blip'); item.s(item.c + 1); }} className={`px-2 py-1 bg-${item.col}-500 hover:bg-${item.col}-600`}>+</Button>
             </div>
           </div>
        ))}
      </div>

      {isComplete && (
        <div className="mt-6 animate-bounce">
          <Button onClick={onComplete} className="bg-green-500 hover:bg-green-600 text-xl px-8 py-3">Next Lab &rarr;</Button>
        </div>
      )}
    </div>
  );
};

// --- STAGE 2: Electron Shells ---
const ElectronShellLevel = ({ onComplete, settings }) => {
    const [knocked, setKnocked] = useState(false);
    
    return (
        <div className="flex flex-col items-center w-full max-w-4xl mx-auto p-4 animate-fadeIn">
            <h2 className="text-2xl font-bold mb-4 text-purple-600">Step 2: Why do they move?</h2>
            <Sparkle 
                message={knocked ? "See that? The nucleus is safe deep inside, but that outer electron is loose and ready to fly!" : "The Nucleus is protected deep inside. But look at the Outside Shell... tap that electron!"} 
                emotion={knocked ? 'excited' : 'happy'}
                speak={settings.speak}
            />

            <div className="relative w-full h-80 bg-gray-900 rounded-xl flex items-center justify-center overflow-hidden border-4 border-gray-700">
                
                {!knocked && <GuideArrow text="Tap the Electron!" className="top-1/3 right-1/3" direction="left" />}

                {/* Fixed Container for precise alignment */}
                <div className="relative w-64 h-64 flex items-center justify-center">
                    {/* Nucleus (Safe) */}
                    <div className="absolute w-32 h-32 bg-gray-800 rounded-full flex items-center justify-center z-10 border-4 border-gray-600">
                        <div className="text-white text-center text-xs">
                            <div className="font-bold text-red-400">Protons</div>
                            <div className="font-bold text-gray-400">Neutrons</div>
                            <div className="text-[10px] mt-1">(Stuck inside)</div>
                        </div>
                    </div>

                    {/* Shell */}
                    <div className="absolute inset-0 border-2 border-dashed border-gray-500 rounded-full"></div>

                    {/* Target Electron - Aligned to right edge of shell */}
                    <button 
                        onClick={() => { setKnocked(true); if(settings.sound) playSound('zap'); }}
                        className={`absolute w-12 h-12 rounded-full bg-yellow-400 flex items-center justify-center font-bold text-black shadow-[0_0_15px_rgba(250,204,21,0.6)] hover:scale-110 transition-transform z-20
                        ${knocked ? 'flying-electron' : 'animate-bounce'}`}
                        style={{ 
                            top: '50%',
                            right: '-1.5rem',
                            marginTop: '-1.5rem',
                            '--tx': '200px', '--ty': '-200px'
                        }}
                    >
                        -
                    </button>
                    {/* Moved Label Down */}
                    <div className="absolute top-[65%] right-[-5rem] text-gray-400 text-sm w-20 text-left">
                        Outer Shell
                    </div>
                </div>
            </div>

            <div className="mt-6 text-center">
                {knocked && (
                    <Button onClick={onComplete} className="bg-green-500 hover:bg-green-600 text-xl px-8 py-3">Got it! Next &rarr;</Button>
                )}
            </div>
        </div>
    );
};

// --- STAGE 3: The Rules of Attraction ---
const ChargesLevel = ({ onComplete, settings }) => {
  const [chargeL, setChargeL] = useState('pos'); // 'pos' or 'neg'
  const [chargeR, setChargeR] = useState('pos');
  const [animating, setAnimating] = useState(false);
  const [tested, setTested] = useState(false);

  const isAttract = chargeL !== chargeR;
  const isRepel = chargeL === chargeR;

  const handleTest = () => {
    setAnimating(true);
    if(settings.sound) playSound(isAttract ? 'swish' : 'zap');
    setTimeout(() => {
        setAnimating(false);
        setTested(true);
    }, 1000);
  };

  const reset = () => {
      setTested(false);
      setAnimating(false);
  }

  useEffect(() => {
      reset();
  }, [chargeL, chargeR]);

  return (
      <div className="flex flex-col items-center w-full max-w-4xl mx-auto p-4 animate-fadeIn">
          <h2 className="text-2xl font-bold mb-4 text-purple-600">Step 3: The Rules of Attraction</h2>
          <Sparkle
              message={tested
                  ? (isAttract ? "Opposites Attract! They pull together like best friends." : "Like charges Repel! They push away because they are too similar.")
                  : "Change the charges to see what happens. Do opposites attract or repel?"}
              speak={settings.speak}
          />

          <div className="relative w-full h-64 bg-gray-100 rounded-xl border-2 border-gray-300 flex items-center justify-center gap-20 overflow-hidden">
              {/* Left Charge */}
              <div className={`w-20 h-20 rounded-full flex items-center justify-center text-4xl font-bold text-white shadow-xl transition-all duration-700
                  ${chargeL === 'pos' ? 'bg-red-500' : 'bg-yellow-400 text-black'}
                  ${(animating || tested) && isAttract ? 'translate-x-[60px]' : ''}
                  ${(animating || tested) && isRepel ? '-translate-x-[60px]' : ''}
              `}>
                  {chargeL === 'pos' ? '+' : '-'}
              </div>

              {/* Force Indicators */}
              <div className="flex flex-col items-center justify-center h-full w-20">
                  {tested && isAttract && <div className="text-4xl font-bold text-green-500 animate-pulse">‚Üí ‚Üê</div>}
                  {tested && isRepel && <div className="text-4xl font-bold text-red-500 animate-pulse">‚Üê ‚Üí</div>}
              </div>

              {/* Right Charge */}
              <div className={`w-20 h-20 rounded-full flex items-center justify-center text-4xl font-bold text-white shadow-xl transition-all duration-700
                  ${chargeR === 'pos' ? 'bg-red-500' : 'bg-yellow-400 text-black'}
                  ${(animating || tested) && isAttract ? '-translate-x-[60px]' : ''}
                  ${(animating || tested) && isRepel ? 'translate-x-[60px]' : ''}
              `}>
                  {chargeR === 'pos' ? '+' : '-'}
              </div>
          </div>

          {/* Controls */}
          <div className="flex justify-between w-full max-w-md mt-6 gap-8">
              <div className="flex gap-2">
                  <Button onClick={() => setChargeL('pos')} disabled={chargeL === 'pos'} className={chargeL === 'pos' ? 'ring-2 ring-offset-2 ring-red-500' : 'opacity-50'}>+</Button>
                  <Button onClick={() => setChargeL('neg')} disabled={chargeL === 'neg'} className={chargeL === 'neg' ? 'ring-2 ring-offset-2 ring-yellow-400' : 'opacity-50'}>-</Button>
              </div>

              <Button onClick={handleTest} className="bg-purple-600 hover:bg-purple-700 w-32">Test!</Button>

              <div className="flex gap-2">
                  <Button onClick={() => setChargeR('pos')} disabled={chargeR === 'pos'} className={chargeR === 'pos' ? 'ring-2 ring-offset-2 ring-red-500' : 'opacity-50'}>+</Button>
                  <Button onClick={() => setChargeR('neg')} disabled={chargeR === 'neg'} className={chargeR === 'neg' ? 'ring-2 ring-offset-2 ring-yellow-400' : 'opacity-50'}>-</Button>
              </div>
          </div>

          <div className="mt-8 h-12">
              {tested && (
                  <Button onClick={onComplete} className="bg-green-500 hover:bg-green-600 text-xl px-8 py-3">Got it! Next &rarr;</Button>
              )}
          </div>
      </div>
  )
}

// --- STAGE 4: Comb & Hair ---
const CombLab = ({ onComplete, settings }) => {
  const [charge, setCharge] = useState(0);
  const [flyingElectrons, setFlyingElectrons] = useState([]);
  const [combPos, setCombPos] = useState({ x: 30, y: 10 }); // Percent

  const handleMove = (e) => {
    const rect = e.currentTarget.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * 100;
    const y = ((e.clientY - rect.top) / rect.height) * 100;
    
    setCombPos({ x: Math.min(90, Math.max(10, x)), y: Math.min(80, Math.max(5, y)) });

    if (y > 50 && x > 20 && x < 80) {
        if (charge < 12 && Math.random() > 0.85) {
            if(settings.sound) playSound('rub');
            const id = Date.now();
            setFlyingElectrons(prev => [...prev, { id, x: Math.random() * 50, y: Math.random() * 20 }]);
            setTimeout(() => {
                setCharge(c => c + 1);
                setFlyingElectrons(prev => prev.filter(e => e.id !== id));
            }, 600);
        }
    }
  };

  return (
    <div className="flex flex-col items-center w-full max-w-4xl mx-auto p-4 animate-fadeIn">
        <h2 className="text-2xl font-bold mb-4 text-purple-600">Step 4: The Comb & Hair</h2>
        <Sparkle message="Time to steal some electrons! Rub the plastic comb on the hair. The friction will knock those outer electrons right onto the comb!" speak={settings.speak} />

        <div className="relative w-full h-80 bg-pink-50 rounded-xl border-2 border-pink-200 overflow-hidden select-none touch-none cursor-none"
             onMouseMove={handleMove}
             onTouchMove={(e) => handleMove(e.touches[0])}
        >
            
            {charge < 3 && <GuideArrow text="Rub here!" className="bottom-20 left-1/2 -translate-x-1/2" direction="down" />}

            {/* Hair Patch - Longer Strands & Taller Area */}
            <div className="absolute bottom-[-15px] left-1/4 w-1/2 h-64 bg-transparent rounded-t-full relative overflow-visible pointer-events-none">
                {Array.from({length: 30}).map((_,i) => (
                    <div key={i} className="absolute bottom-0 w-1 bg-yellow-800 origin-bottom" style={{height: `${120 + Math.random()*80}%`, left: `${i*3.5}%`, transform: `rotate(${(i-15)*2.5}deg)`}}></div>
                ))}
                {/* Scalp base */}
                <div className="absolute bottom-0 w-full h-20 bg-yellow-900 rounded-t-full"></div>
                <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 text-white font-bold opacity-50">HAIR</div>
            </div>

            {/* Comb */}
            <div className="absolute w-64 h-24 bg-purple-600 rounded-lg transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center justify-center z-20 shadow-xl pointer-events-none"
                 style={{ left: `${combPos.x}%`, top: `${combPos.y}%` }}>
                 <div className="w-full h-4 bg-purple-700 mt-auto flex justify-around">
                     {Array.from({length:15}).map((_,i) => <div key={i} className="w-1 h-8 bg-purple-600"></div>)}
                 </div>
                 <div className="absolute top-2 text-white font-bold opacity-80">PLASTIC COMB</div>
                 
                 <div className="absolute top-0 right-0 flex flex-wrap w-full h-full p-2 gap-1 justify-center">
                    {Array.from({length: charge}).map((_, i) => (
                        <div key={`c-${i}`} className="w-4 h-4 bg-yellow-300 rounded-full text-[10px] flex items-center justify-center font-bold animate-pulse">-</div>
                    ))}
                 </div>
            </div>

            {flyingElectrons.map(e => (
                <div key={e.id} className="absolute bottom-20 left-1/2 w-6 h-6 bg-yellow-400 rounded-full flex items-center justify-center font-bold z-30 flying-electron"
                     style={{ '--tx': '0px', '--ty': '-150px' }}>
                    -
                </div>
            ))}
        </div>

        <div className="mt-4 text-center">
            <p className="text-lg">Electrons Stolen: <span className="font-bold text-xl">{charge} / 12</span></p>
        </div>

        {charge >= 12 && (
             <div className="mt-6 animate-bounce">
                <Button onClick={onComplete} className="bg-green-500 hover:bg-green-600 text-xl px-8 py-3">Next: Balloon Lab &rarr;</Button>
             </div>
        )}
    </div>
  );
};

// --- STAGE 5: Balloon Experiment Hub ---
const BalloonLab = ({ onComplete, settings }) => {
    const [subStage, setSubStage] = useState('charge'); 
    const [charge, setCharge] = useState(0);
    const [flying, setFlying] = useState([]);
    
    const [papers, setPapers] = useState(Array.from({length: 12}).map((_,i) => ({
        id:i, 
        initialX: 20 + i*6, 
        clumpOffset: (Math.random() * 10) - 5,
        lifted: false
    })));
    
    const [canX, setCanX] = useState(20);
    const [balloonPos, setBalloonPos] = useState({ x: 80, y: 30 }); 

    const handleInteraction = (e) => {
        const rect = e.currentTarget.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;

        const x = ((clientX - rect.left) / rect.width) * 100;
        const y = ((clientY - rect.top) / rect.height) * 100;
        
        setBalloonPos({ x, y });

        if (subStage === 'charge') {
            if (x > 60 && y > 60) {
                if (charge < 15 && Math.random() > 0.8) {
                    if(settings.sound) playSound('rub');
                    const id = Date.now();
                    setFlying(prev => [...prev, {id}]);
                    setTimeout(() => {
                        setCharge(c => c + 1);
                        setFlying(prev => prev.filter(x => x.id !== id));
                    }, 500);
                }
            }
        } else if (subStage === 'paper') {
            setPapers(prev => prev.map(p => {
                const dist = Math.abs(p.initialX - x);
                const isClose = dist < 20 && y > 50; 
                
                if (charge > 5 && isClose && !p.lifted) {
                    if(settings.sound && Math.random() > 0.8) playSound('swish');
                    return {...p, lifted: true};
                }
                if ((dist > 25 || y < 40) && p.lifted) {
                    return {...p, lifted: false};
                }
                return p;
            }));
        } else if (subStage === 'can') {
            const dist = x - canX;
            if (charge > 5 && Math.abs(dist) < 35 && Math.abs(dist) > 5 && y > 50) {
                setCanX(prev => {
                    const next = prev + (dist > 0 ? 0.8 : -0.8);
                    if(settings.sound && Math.random() > 0.9) playSound('roll'); 
                    return next;
                });
            }
        }
    };

    const getSparkleMsg = () => {
        switch(subStage) {
            case 'charge': return "First things first! Rub the balloon on the sweater to load it up with negative electrons.";
            case 'paper': return "Now that the balloon is charged, lower it over the paper. The negative balloon pushes the paper's electrons away, making the top positive. Opposites attract!";
            case 'can': return "Aluminum cans are neutral, but the balloon can still pull it! Guide the can across the table.";
            case 'wall': return "The classic trick! Stick the balloon to the wall. The balloon pushes the wall's electrons deeper, sticking to the positive surface left behind.";
            default: return "";
        }
    }

    return (
        <div className="flex flex-col items-center w-full max-w-4xl mx-auto p-4 animate-fadeIn">
            <div className="w-full flex flex-col md:flex-row gap-4 mb-4">
                <div className="flex-1">
                    <Sparkle message={getSparkleMsg()} speak={settings.speak} />
                </div>
                {/* Microscope View Panel - Visible only in Paper & Can Stages */}
                {(subStage === 'paper' || subStage === 'can') && (
                    <div className="w-full md:w-64 bg-blue-50 rounded-xl border-4 border-blue-200 p-3 shadow-inner flex flex-col animate-fadeIn shrink-0 h-64 md:h-auto">
                        <h4 className="font-bold text-blue-800 text-center mb-2 border-b border-blue-200 pb-1">Microscope View üî¨</h4>
                        
                        {/* Visualization Container */}
                        <div className="flex-grow relative bg-white rounded-lg border border-gray-300 overflow-hidden flex flex-col">
                            
                            {/* Balloon Surface (Top) */}
                            <div className="h-1/3 bg-purple-500 w-full flex items-center justify-center gap-1 text-white font-bold text-sm shadow-md z-10 transition-all duration-300"
                                 style={{ transform: `translateY(${ (1 - (subStage === 'paper' ? (balloonPos.y > 50 ? 1 : 0) : (Math.abs(balloonPos.x - canX) < 40 ? 1 : 0))) * -10 }px)` }}>
                                 {/* Show negative charges if charged */}
                                 {charge > 0 ? Array.from({length: 5}).map((_, i) => <div key={i}>-</div>) : <span className="opacity-70 text-xs">Neutral</span>}
                            </div>

                            {/* Field Area */}
                            <div className="flex-grow relative flex justify-center items-center">
                                {charge > 5 && (subStage === 'paper' ? balloonPos.y > 50 : Math.abs(balloonPos.x - canX) < 40) && (
                                    <div className="text-yellow-500 text-xs font-bold animate-pulse rotate-90">REPULSION &rarr;</div>
                                )}
                            </div>

                            {/* Object Surface (Bottom) */}
                            <div className="h-1/2 bg-gray-100 w-full border-t-2 border-gray-300 relative p-1">
                                <div className="absolute -top-4 left-1 bg-white px-1 text-[10px] text-gray-500 font-bold border border-gray-200 rounded">{subStage === 'paper' ? 'Paper' : 'Aluminum Can'}</div>
                                
                                <div className="grid grid-cols-4 gap-1 h-full content-center place-items-center">
                                    {Array.from({length: 8}).map((_, i) => (
                                        <div key={i} className="relative w-4 h-4 flex justify-center">
                                            {/* Proton (Fixed) */}
                                            <div className="w-4 h-4 bg-red-500 rounded-full flex items-center justify-center text-white text-[8px] font-bold z-10 shadow-sm">+</div>
                                            {/* Electron logic */}
                                            <div className="absolute w-3 h-3 bg-yellow-400 rounded-full flex items-center justify-center text-[8px] font-bold transition-all duration-500 ease-out z-20 shadow-sm border border-yellow-600"
                                                 style={{ 
                                                     top: (charge > 5 && (subStage === 'paper' ? balloonPos.y > 50 : Math.abs(balloonPos.x - canX) < 40)) ? '180%' : '20%', 
                                                     opacity: 1 
                                                 }}>
                                                -
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                {/* Surface Charge Indicator */}
                                <div className={`absolute top-0 right-1 text-[8px] font-bold text-red-500 transition-opacity duration-300 ${(charge > 5 && (subStage === 'paper' ? balloonPos.y > 50 : Math.abs(balloonPos.x - canX) < 40)) ? 'opacity-100' : 'opacity-0'}`}>
                                    + Surface
                                </div>
                            </div>
                        </div>
                        
                        <p className="text-[10px] text-center mt-2 text-gray-600 leading-tight">
                            {subStage === 'paper' 
                                ? "Negative balloon pushes paper's electrons deep inside!" 
                                : "Metal electrons run away fast! Positive surface pulls the can."}
                        </p>
                    </div>
                )}
            </div>

            <div className="flex gap-2 mb-4 overflow-x-auto w-full justify-center pb-2">
                <Button onClick={() => setSubStage('charge')} disabled={subStage === 'charge'} className="text-sm">1. Charge It</Button>
                <Button onClick={() => setSubStage('paper')} disabled={charge < 5} className="text-sm">{charge < 5 ? "üîí " : ""}2. Paper Bits</Button>
                <Button onClick={() => setSubStage('can')} disabled={charge < 5} className="text-sm">{charge < 5 ? "üîí " : ""}3. Soda Can</Button>
                <Button onClick={() => setSubStage('wall')} disabled={charge < 5} className="text-sm">{charge < 5 ? "üîí " : ""}4. Wall Stick</Button>
            </div>

            <div className="relative w-full h-96 bg-blue-50 rounded-xl border-2 border-blue-200 overflow-hidden select-none touch-none cursor-none"
                 onMouseMove={handleInteraction}
                 onTouchMove={handleInteraction}
            >
                {subStage === 'charge' && charge < 5 && <GuideArrow text="Rub here!" className="bottom-20 right-20" direction="down" />}
                {subStage === 'paper' && <GuideArrow text="Move Down" className="bottom-40 left-1/2 -translate-x-1/2" direction="down" />}
                {subStage === 'can' && <GuideArrow text="Lead the Can" className="bottom-40 left-1/4" direction="right" />}
                {subStage === 'wall' && <GuideArrow text="Go to Wall" className="top-1/2 right-40" direction="right" />}

                {subStage === 'charge' && (
                    <>
                        <div className="absolute bottom-0 right-10 w-48 h-48 bg-orange-200 rounded-t-3xl flex flex-wrap content-start p-4 gap-2 opacity-90">
                            <span className="absolute -top-8 font-bold text-orange-800">Sweater</span>
                            {Array.from({length: 8}).map((_, i) => <div key={`sp-${i}`} className="w-4 h-4 rounded-full bg-red-400 flex items-center justify-center text-[10px] text-white font-bold">+</div>)}
                            {Array.from({length: 15 - charge}).map((_, i) => <div key={`se-${i}`} className="w-4 h-4 rounded-full bg-yellow-400 flex items-center justify-center text-[10px] font-bold">-</div>)}
                        </div>
                        {flying.map(f => (
                            <div key={f.id} className="absolute bottom-20 right-20 w-6 h-6 bg-yellow-400 rounded-full flex items-center justify-center font-bold z-30 flying-electron"
                                 style={{ '--tx': '-100px', '--ty': '-100px' }}>-</div>
                        ))}
                    </>
                )}

                {subStage === 'paper' && (
                    <div className="absolute bottom-0 w-full h-20 bg-gray-200 border-t-2 border-gray-300">
                        {papers.map(p => (
                            <div key={p.id} className="absolute w-5 h-5 bg-white shadow-sm border border-gray-300 transition-all duration-300 ease-out flex flex-col items-center justify-center"
                                 style={{ 
                                     left: p.lifted ? `${balloonPos.x + p.clumpOffset}%` : `${p.initialX}%`, 
                                     bottom: p.lifted ? `${Math.max(10, (100 - balloonPos.y) - 5)}%` : '10%',
                                     transform: `rotate(${p.id * 20}deg)`
                                 }}>
                                 {/* Added charges */}
                                 <span className="text-[6px] font-bold text-red-500 leading-none select-none">+</span>
                                 <span className="text-[6px] font-bold text-blue-500 leading-none select-none">-</span>
                            </div>
                        ))}
                    </div>
                )}

                {subStage === 'can' && (
                    <div className="absolute bottom-10 w-16 h-24 bg-gradient-to-r from-gray-300 via-gray-100 to-gray-400 border border-gray-500 rounded-lg flex items-center justify-center smooth-catchup"
                         style={{ left: `${canX}%`, transform: `translateX(-50%) rotate(${canX * 10}deg)` }}>
                        <div className="text-xs font-bold text-gray-500 rotate-90">SODA</div>
                    </div>
                )}

                {subStage === 'wall' && (
                    <div className="absolute right-0 h-full w-32 bg-yellow-100 border-l-4 border-yellow-200 flex flex-col justify-around p-2">
                        {Array.from({length:5}).map((_,i) => (
                             <div key={i} className="flex gap-2 items-center">
                                 <div className="w-6 h-6 bg-red-400 rounded-full flex items-center justify-center text-white text-xs">+</div>
                                 <div className="w-5 h-5 bg-yellow-400 rounded-full flex items-center justify-center text-xs transition-transform duration-300"
                                      style={{ transform: balloonPos.x > 80 ? 'translateX(20px)' : 'translateX(0)' }}>-</div>
                             </div>
                        ))}
                    </div>
                )}

                <div className="absolute w-32 h-40 bg-purple-500 rounded-[50%_50%_50%_50%/40%_40%_60%_60%] shadow-xl flex items-center justify-center z-50 pointer-events-none no-lag"
                     style={{ 
                         left: `${balloonPos.x}%`, 
                         top: `${balloonPos.y}%`,
                         transform: 'translate(-50%, -50%) rotate(-10deg)',
                     }}>
                     <div className="absolute -bottom-3 w-3 h-5 bg-purple-600"></div>
                     <div className="grid grid-cols-4 gap-1 p-4">
                        {Array.from({length: charge}).map((_, i) => (
                            <div key={`b-${i}`} className="w-4 h-4 rounded-full bg-yellow-300 text-[8px] flex items-center justify-center font-bold select-none">-</div>
                        ))}
                     </div>
                </div>
            </div>
             
             {subStage === 'wall' && (
                 <div className="mt-6 animate-bounce">
                    <Button onClick={onComplete} className="bg-green-500 hover:bg-green-600 text-xl px-8 py-3">Finish Experiments &rarr;</Button>
                 </div>
             )}
        </div>
    );
};

// --- STAGE 6: Daily Life Simulations ---
const DailyLife = ({ onComplete, settings }) => {
    const [level, setLevel] = useState(null); 
    const [sockPos, setSockPos] = useState(0); 
    const [cloudCharge, setCloudCharge] = useState(0);
    const [strike, setStrike] = useState(false);

    // Door knob state
    const [personX, setPersonX] = useState(10); 
    const [personCharge, setPersonCharge] = useState(0);
    const [zap, setZap] = useState(false);
    const draggingRef = useRef(false);

    const resetLevel = () => {
        setSockPos(0);
        setPersonX(10);
        setPersonCharge(0);
        setZap(false);
        setCloudCharge(0);
        setStrike(false);
    }

    const renderMenu = () => (
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 w-full animate-fadeIn">
            {[
                {id: 'laundry', t: 'Sticky Laundry', i: 'üëï'},
                {id: 'doorknob', t: 'The Door Knob', i: 'üö™'},
                {id: 'lightning', t: 'Lightning Storm', i: '‚ö°'}
            ].map(l => (
                <button key={l.id} onClick={() => { resetLevel(); setLevel(l.id); }} className="bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl transition-all border-t-8 border-blue-400 hover:-translate-y-2">
                    <div className="text-6xl mb-4">{l.i}</div>
                    <h3 className="font-bold text-xl">{l.t}</h3>
                </button>
            ))}
            <div className="md:col-span-3 text-center mt-8">
                <Button onClick={onComplete} className="bg-purple-600 hover:bg-purple-700 text-xl px-10 py-3">Take the Quiz! &rarr;</Button>
            </div>
        </div>
    );

    const getSparkleMsg = () => {
        if (!level) return "Static electricity is everywhere! Pick a scenario to explore.";
        if (level === 'laundry') return "Clothes rubbing together in the dryer transfer electrons. Pull the sock off the shirt!";
        if (level === 'doorknob') return "Drag the person left and right to scrub their feet on the carpet. When you're fully charged, touch the knob to ZAP!";
        if (level === 'lightning') return "Clouds are just big static machines! Rub them together to make lightning.";
    }

    return (
        <div className="flex flex-col items-center w-full max-w-4xl mx-auto p-4 animate-fadeIn">
            <h2 className="text-3xl font-bold text-blue-600 mb-6">Daily Life Examples</h2>
            <Sparkle message={getSparkleMsg()} emotion={zap || strike ? 'shocked' : 'happy'} speak={settings.speak} />

            {!level && renderMenu()}

            {level === 'laundry' && (
                <div className="w-full bg-white p-8 rounded-xl shadow-xl flex flex-col items-center">
                    <div className="relative w-64 h-64 bg-gray-100 rounded-lg border-2 border-gray-200 flex items-center justify-center">
                        <div className="w-32 h-40 bg-blue-500 rounded flex items-center justify-center text-white relative">
                            Shirt
                            {sockPos < 80 && sockPos > 10 && <div className="absolute right-0 top-1/2 text-yellow-400 text-2xl font-bold animate-pulse">‚ö°</div>}
                        </div>
                        <div className="absolute w-16 h-24 bg-red-400 rounded-b-full flex items-center justify-center text-white cursor-grab active:cursor-grabbing transition-transform duration-75"
                             style={{ 
                                 transform: `translateX(${sockPos}px) rotate(${sockPos/2}deg)`,
                                 left: '50%' 
                             }}
                             onMouseDown={(e) => {
                                 const startX = e.clientX;
                                 const onMove = (mv) => {
                                     const diff = Math.max(0, Math.min(150, mv.clientX - startX));
                                     setSockPos(diff);
                                     if (Math.random() > 0.9 && settings.sound) playSound('rub');
                                 };
                                 const onUp = () => {
                                     document.removeEventListener('mousemove', onMove);
                                     document.removeEventListener('mouseup', onUp);
                                     if (sockPos < 100) setSockPos(0); 
                                     else playSound('pop');
                                 };
                                 document.addEventListener('mousemove', onMove);
                                 document.addEventListener('mouseup', onUp);
                             }}
                        >
                            Sock
                        </div>
                    </div>
                    {sockPos >= 100 && <div className="text-green-600 font-bold mt-4 animate-bounce">POP! Static Release!</div>}
                    <Button onClick={() => setLevel(null)} className="mt-6">Back</Button>
                </div>
            )}

            {level === 'doorknob' && (
                <div className="w-full bg-white p-8 rounded-xl shadow-xl flex flex-col items-center select-none"
                     onMouseUp={() => draggingRef.current = false}
                     onMouseLeave={() => draggingRef.current = false}
                >
                    <div className="w-full h-80 relative bg-purple-50 rounded-lg border-b-8 border-yellow-700 overflow-hidden"
                         onMouseMove={(e) => {
                             if (!draggingRef.current) return;
                             const rect = e.currentTarget.getBoundingClientRect();
                             const x = ((e.clientX - rect.left) / rect.width) * 100;
                             
                             const delta = Math.abs(x - personX);
                             if (delta > 0.5) {
                                 setPersonCharge(c => Math.min(100, c + 1));
                                 if (settings.sound && Math.random() > 0.8) playSound('rub');
                             }
                             
                             setPersonX(Math.max(5, Math.min(80, x)));
                             
                             if (x > 75 && personCharge > 50) {
                                 setZap(true);
                                 setPersonCharge(0);
                                 draggingRef.current = false;
                                 playSound('zap');
                             }
                         }}
                         onMouseDown={() => { if(!zap) draggingRef.current = true; }}
                    >
                         <div className="absolute bottom-0 w-full h-8 bg-yellow-800 opacity-20" 
                              style={{backgroundImage: 'repeating-linear-gradient(45deg, transparent, transparent 10px, #000 10px, #000 11px)'}}></div>

                         {personCharge < 50 && !zap && <div className="absolute top-4 left-1/2 -translate-x-1/2 text-gray-500 font-bold animate-pulse">&larr; SCRUB FEET LEFT & RIGHT &rarr;</div>}
                         {personCharge >= 50 && !zap && <div className="absolute top-4 left-1/2 -translate-x-1/2 text-red-500 font-bold animate-pulse">CHARGED! TOUCH THE KNOB! &rarr;</div>}

                         <div className="absolute right-0 top-1/3 w-8 h-24 bg-gray-300 rounded-l-lg border-l-2 border-gray-400 flex items-center justify-center">
                             <div className="w-6 h-6 rounded-full bg-yellow-500 border-2 border-yellow-700 shadow-sm relative">
                                 {zap && <div className="absolute -left-10 -top-10 text-6xl animate-ping">‚ö°</div>}
                             </div>
                         </div>

                         <div className={`absolute bottom-0 w-24 h-56 transition-transform duration-75 cursor-ew-resize`}
                              style={{ left: `${personX}%`, transform: 'translateX(-50%)' }}
                         >
                              <div className="absolute top-0 left-1/2 -translate-x-1/2 w-16 h-16 bg-blue-200 rounded-full border-2 border-blue-300 flex items-center justify-center text-2xl">
                                  {zap ? 'üò≤' : 'üôÇ'}
                              </div>
                              <div className="absolute top-16 left-1/2 -translate-x-1/2 w-12 h-24 bg-blue-500 rounded-lg"></div>
                              <div className="absolute top-20 right-0 w-16 h-4 bg-blue-500 rounded-full origin-left rotate-[-10deg]"></div>
                              <div className="absolute top-16 -right-5 w-6 h-6 bg-blue-200 rounded-full"></div> 
                              
                              <div className={`absolute bottom-0 left-2 w-4 h-16 bg-blue-700 ${draggingRef.current ? 'animate-bounce' : ''}`}></div>
                              <div className={`absolute bottom-0 right-2 w-4 h-16 bg-blue-700 ${draggingRef.current ? 'animate-bounce' : ''} animation-delay-100`}></div>
                              
                              <div className="absolute inset-0 border-4 border-yellow-400 rounded-full opacity-0 transition-opacity duration-200"
                                   style={{ opacity: personCharge / 100 }}></div>
                         </div>
                    </div>

                    <div className="w-full h-6 bg-gray-200 rounded-full mt-4 overflow-hidden border border-gray-300">
                        <div className="h-full bg-gradient-to-r from-yellow-200 to-red-500 transition-all duration-100" style={{width: `${personCharge}%`}}></div>
                    </div>
                    <div className="text-center text-sm font-bold text-gray-500 mt-1">STATIC CHARGE LEVEL</div>

                    <Button onClick={() => setLevel(null)} className="mt-6">Back</Button>
                </div>
            )}

            {level === 'lightning' && (
                <div className="w-full bg-white p-8 rounded-xl shadow-xl flex flex-col items-center">
                    <div className="relative w-full h-64 bg-gray-800 rounded-xl overflow-hidden" 
                         onMouseMove={(e) => { 
                             if(e.buttons === 1 && !strike) { 
                                 setCloudCharge(c => Math.min(100, c + 1)); 
                                 if (settings.sound && Math.random() > 0.8) playSound('rub');
                                 if(cloudCharge > 98) { setStrike(true); playSound('zap'); }
                             }
                         }}
                    >
                         {strike && <div className="absolute inset-0 bg-white animate-ping opacity-50"></div>}
                         {strike && (<svg className="absolute inset-0 w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M50 20 L40 50 L60 50 L30 90" stroke="yellow" strokeWidth="2" fill="none" className="animate-pulse" /></svg>)}
                         <div className="absolute top-10 left-1/2 -translate-x-1/2 w-40 h-20 bg-gray-400 rounded-full blur-sm opacity-80 cursor-grab active:cursor-grabbing"><div className="absolute top-0 right-0 w-20 h-20 bg-gray-400 rounded-full -mt-8"></div><div className="absolute top-0 left-0 w-20 h-20 bg-gray-400 rounded-full -mt-6"></div></div>
                         <div className="absolute bottom-0 w-full flex items-end justify-center gap-2 opacity-50"><div className="w-8 h-10 bg-black"></div><div className="w-10 h-20 bg-black"></div><div className="w-6 h-8 bg-black"></div></div>
                    </div>
                    <div className="w-64 h-4 bg-gray-700 rounded mt-4 overflow-hidden border border-gray-500"><div className="h-full bg-yellow-400 transition-all duration-200" style={{width: `${cloudCharge}%`}}></div></div>
                    <Button onClick={() => setLevel(null)} className="mt-6">Back</Button>
                </div>
            )}
        </div>
    );
};

// --- STAGE 7: Quiz ---
const QuizLevel = ({ onRestart, settings }) => {
    const [qIndex, setQIndex] = useState(0);
    const [score, setScore] = useState(0);
    const [showResult, setShowResult] = useState(false);
    const [selected, setSelected] = useState(null);

    const questions = [
        {
            q: "Where are electrons located in an atom?",
            o: ["Deep in the center", "On the outer shells", "Inside the protons", "They don't exist"],
            a: 1, 
            f: [ 
                "Not quite. The center (Nucleus) holds Protons and Neutrons. Electrons are on the outside!",
                "Correct! They fly around the outer shells, making them easy to move.",
                "Protons are separate particles in the nucleus. Electrons orbit around them.",
                "They definitely exist! We just spent the whole lab playing with them!"
            ]
        },
        {
            q: "What charge does an electron have?",
            o: ["Positive (+)", "Neutral (0)", "Negative (-)", "Spicy"],
            a: 2,
            f: [
                "Protons are Positive (+). Electrons are the opposite.",
                "Neutrons are Neutral (0). Electrons have a charge.",
                "Correct! Electrons are Negative (-).",
                "Haha, no! Electrons are shocking, not spicy!"
            ]
        },
        {
            q: "How is static electricity created?",
            o: ["By cooling down atoms", "By friction (rubbing)", "By melting plastic", "By adding water"],
            a: 1,
            f: [
                "Temperature isn't the key here.",
                "Correct! Friction (rubbing) knocks those loose outer electrons off one object and onto another.",
                "Melting changes the state of matter, not the electrical charge.",
                "Water conducts electricity, but it doesn't create static charge by itself."
            ]
        },
        {
            q: "What happens when two objects have Opposite charges (+ and -)?",
            o: ["They Attract", "They Repel", "They Explode", "Nothing"],
            a: 0,
            f: [
                "Spot on! Opposites Attract! Positive pulls Negative.",
                "Likes repel (++/--). Opposites do the reverse!",
                "Ideally not in this lab! They just pull together.",
                "There is definitely a force involved!"
            ]
        },
        {
            q: "Why did the paper stick to the balloon?",
            o: ["The paper was magnetic", "Glue", "The balloon polarized the paper", "Magic"],
            a: 2,
            f: [
                "Paper isn't magnetic. Something electrical is happening.",
                "No glue involved! It's all static.",
                "Correct! The negative balloon pushed the paper's electrons away, creating a positive side that attracted to the balloon.",
                "It looks like magic, but it's Science!"
            ]
        }
    ];

    const handleAnswer = (idx) => {
        setSelected(idx);
        if (idx === questions[qIndex].a) {
            setScore(s => s + 1);
            if(settings.sound) playSound('success');
        } else {
            if(settings.sound) playSound('fail');
        }
    };

    const nextQuestion = () => {
        if (qIndex < questions.length - 1) {
            setQIndex(i => i + 1);
            setSelected(null);
        } else {
            setShowResult(true);
        }
    };

    if (showResult) {
        return (
            <div className="flex flex-col items-center w-full max-w-4xl mx-auto p-8 bg-white rounded-xl shadow-xl animate-fadeIn mt-10">
                <Sparkle 
                    message={score === 5 ? "WOW! A perfect score! You're a true Static Scientist!" : "Great effort! You've learned a lot today."} 
                    emotion="excited" 
                    speak={settings.speak}
                />
                <h2 className="text-4xl font-bold text-blue-600 mb-4">Quiz Complete!</h2>
                <div className="text-6xl font-bold mb-8">{score} / {questions.length}</div>
                
                <div className="bg-blue-50 p-6 rounded-xl text-left w-full mb-8 border-l-8 border-blue-500">
                    <h3 className="text-2xl font-bold text-blue-800 mb-4">Mission Debrief: What We Learned</h3>
                    <ul className="space-y-3 text-lg text-gray-700">
                        <li>‚öõÔ∏è <strong>Atoms:</strong> Protons (+) and Neutrons (0) are stuck in the nucleus. Electrons (-) fly on the outside.</li>
                        <li>‚ö° <strong>Static Charge:</strong> Friction (rubbing) steals those loose outer electrons.</li>
                        <li>üß≤ <strong>The Golden Rule:</strong> Opposites Attract (+ and -), Likes Repel (- and -).</li>
                        <li>üåç <strong>Real Life:</strong> Lightning, doorknob shocks, and sticky laundry are all static electricity in action!</li>
                    </ul>
                </div>

                <Button onClick={onRestart} className="px-8 py-4 text-xl bg-purple-600">Restart Simulation</Button>
            </div>
        );
    }

    const q = questions[qIndex];

    return (
        <div className="flex flex-col items-center w-full max-w-2xl mx-auto p-4 animate-fadeIn mt-6">
            <h2 className="text-2xl font-bold text-purple-600 mb-6">Review Quiz</h2>
            <Sparkle 
                message={selected !== null ? (selected === q.a ? "You got it! " + q.f[selected] : "Oops! " + q.f[selected]) : q.q} 
                speak={settings.speak}
                emotion={selected !== null && selected !== q.a ? 'shocked' : 'happy'}
            />
            <div className="w-full bg-white p-6 rounded-xl shadow-lg">
                <div className="flex justify-between text-sm text-gray-500 mb-4">
                    <span>Question {qIndex + 1} of {questions.length}</span>
                    <span>Score: {score}</span>
                </div>
                
                <div className="space-y-3 mb-6">
                    {q.o.map((opt, i) => (
                        <button 
                            key={i} 
                            onClick={() => selected === null && handleAnswer(i)}
                            disabled={selected !== null}
                            className={`w-full p-4 rounded-lg text-left font-medium transition-colors border-2 
                                ${selected === null ? 'bg-gray-50 border-gray-200 hover:bg-blue-50 hover:border-blue-300' : 
                                  i === q.a ? 'bg-green-100 border-green-500 text-green-800' : 
                                  selected === i ? 'bg-red-100 border-red-500 text-red-800' : 'bg-gray-50 border-gray-200 opacity-50'
                                }`}
                        >
                            {opt}
                        </button>
                    ))}
                </div>

                {selected !== null && (
                    <div className="animate-fadeIn">
                        <div className={`p-4 rounded-lg mb-4 text-sm font-bold ${selected === q.a ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>
                            {q.f[selected]} {selected !== q.a && <span className="block mt-1">The correct answer is: {q.o[q.a]}</span>}
                        </div>
                        <div className="text-right">
                             <Button onClick={nextQuestion}>Next &rarr;</Button>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

// --- Main App Controller ---
const App = () => {
  const [stage, setStage] = useState(0); 
  const [showCredits, setShowCredits] = useState(false);
  const [settings, setSettings] = useState({ sound: true, speak: true });

  const toggleSound = () => {
    setSettings(s => {
      const newSound = !s.sound;
      toggleMusic(newSound); // Toggle music with sound
      return {...s, sound: newSound, speak: newSound};
    });
  };

  useEffect(() => {
    // Ensure music stops if unmounted or sound off initially
    return () => toggleMusic(false);
  }, []);

  return (
    <div className="min-h-screen pb-12 flex flex-col relative">
      <GlobalStyles />
      
      {/* Header */}
      <header className="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-50 flex justify-between items-center">
        <div className="max-w-4xl flex-col items-start gap-0">
          <div className="flex items-center gap-2">
            <h1 className="text-xl md:text-2xl font-bold flex items-center gap-2">
              ‚ö° Sparkle's Static Lab
            </h1>
            <div className="text-sm font-light hidden sm:block">| Grade 5 Science</div>
          </div>
          
          <div className="relative ml-8">
                <button 
                    onClick={() => setShowCredits(!showCredits)}
                    className="flex items-center gap-1 text-xs text-blue-200 hover:text-white transition-colors"
                >
                    <span className="w-4 h-4 rounded-full border border-current flex items-center justify-center font-bold text-[10px]">i</span>
                    <span>Info</span>
                </button>
                {showCredits && (
                    <div className="absolute left-0 top-6 bg-white text-gray-800 p-4 rounded shadow-xl w-64 text-sm z-50 border border-gray-200 animate-fadeIn text-left">
                        <p className="font-bold mb-1">Created by:</p>
                        <p>Sir Angelo Medez</p>
                        <p className="text-xs text-gray-500 mt-2">via Gemini Canvas</p>
                    </div>
                )}
            </div>
        </div>
        
        <div className="flex gap-2">
            {/* Sound Toggle */}
            <button 
                onClick={toggleSound}
                className="w-8 h-8 rounded-full bg-white/20 hover:bg-white/40 flex items-center justify-center font-bold text-lg transition-colors"
                title="Toggle Sound/Voice"
            >
                {settings.speak ? 'üîä' : 'üîá'}
            </button>
        </div>
      </header>

      <main className="container mx-auto mt-6 px-2 flex-grow">
        {/* Progress Bar */}
        <div className="max-w-xl mx-auto mb-8 flex justify-between items-center px-4 relative">
          <div className="absolute left-0 right-0 top-1/2 h-1 bg-gray-300 -z-10"></div>
          {['Atom', 'Shells', 'Forces', 'Comb', 'Balloon', 'Daily', 'Quiz'].map((label, idx) => {
              const s = idx + 1;
              return (
                <div key={s} className="flex flex-col items-center z-10">
                    <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold transition-colors duration-500 ${stage >= s ? 'bg-blue-600 text-white' : 'bg-gray-300 text-gray-500'}`}>
                    {s}
                    </div>
                    <span className="text-[10px] sm:text-xs mt-1 text-gray-500 hidden sm:block">{label}</span>
                </div>
              );
          })}
        </div>

        {stage === 0 && (
          <div className="text-center mt-12 animate-fadeIn flex flex-col items-center">
            <h1 className="text-4xl md:text-6xl font-bold text-blue-800 mb-6 floating">Hello, Lasallian Scientists!</h1>
            <p className="text-2xl text-purple-600 font-bold mb-4">Welcome to the Static Lab.</p>
            <Sparkle message="Hi! I'm Sparkle! I'll be your guide today as we explore the shocking world of static electricity!" speak={settings.speak} />
            <div className="max-w-md mx-auto text-left bg-white p-6 rounded-lg shadow-md mb-8 space-y-2">
                <p className="text-lg font-bold text-gray-700">Your Mission:</p>
                <ol className="list-decimal pl-5 text-gray-600 space-y-1">
                    <li><strong>Build an Atom:</strong> Learn the parts.</li>
                    <li><strong>Explore Shells:</strong> See why electrons move.</li>
                    <li><strong>Master Forces:</strong> Discover how charges attract and repel.</li>
                    <li><strong>Charge Objects:</strong> Use friction to steal electrons.</li>
                    <li><strong>Perform Magic:</strong> Roll cans, lift paper, and stick balloons!</li>
                </ol>
            </div>
            <Button onClick={() => { setStage(1); toggleMusic(settings.sound); }} className="text-2xl px-10 py-4 shadow-xl bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600">Start Lab</Button>
          </div>
        )}

        {stage === 1 && <AtomBuilder onComplete={() => setStage(2)} settings={settings} />}
        {stage === 2 && <ElectronShellLevel onComplete={() => setStage(3)} settings={settings} />}
        {stage === 3 && <ChargesLevel onComplete={() => setStage(4)} settings={settings} />}
        {stage === 4 && <CombLab onComplete={() => setStage(5)} settings={settings} />}
        {stage === 5 && <BalloonLab onComplete={() => setStage(6)} settings={settings} />}
        {stage === 6 && <DailyLife onComplete={() => setStage(7)} settings={settings} />}
        {stage === 7 && <QuizLevel onRestart={() => setStage(0)} settings={settings} />}

      </main>
    </div>
  );
};

export default App;
